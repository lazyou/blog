## 通俗讲解 异步，非阻塞和 IO 复用
* https://www.zybuluo.com/phper/note/595507


## 1. 阅前热身
* 为了更加形象的说明同步异步、阻塞非阻塞，我们以小明去买奶茶为例。


## 1.1 同步与异步
* 同步与异步的理解

* 同步与异步的重点在 __消息通知的方式上__，也就是调用结果通知的方式。 
    * __同步__: 当一个同步调用发出去后，调用者要一直等待调用结果的通知后，才能进行后续的执行。 

    * __异步__：当一个异步调用发出去后，调用者不能立即得到调用结果的返回。 

* __异步__ 调用，要想获得结果，一般有两种方式：
    1. 主动 __轮询__ 异步调用的结果;
    2. 被调用方通过 __callback__ 来通知调用方调用结果。

* 生活中的例子
    * 同步 买奶茶：小明点单交钱，然后等着拿奶茶；异步买奶茶：小明点单交钱，店员给小明一个小票，等小明奶茶做好了，再来取。

    * 异步 买奶茶: 小明要想知道奶茶是否做好了，有两种方式：
        1. 小明主动去问店员，一会就去问一下：“奶茶做好了吗？”...直到奶茶做好。这叫 __轮询__。
        2. 等奶茶做好了，店员喊一声：“小明，奶茶好了！”，然后小明去取奶茶。这叫 __回调__。


## 1.2 阻塞与非阻塞
* 阻塞与非阻塞的理解

* 阻塞与非阻塞的重点在于 __进/线程等待消息时候的行为__，也就是 _在等待消息的时候，当前进/线程是挂起状态，还是非挂起状态_。

    * __阻塞调用__ 在发出去后，在消息返回之前，当前进/线程会被挂起，直到有消息返回，当前进/线程才会被激活.

    * __非阻塞调用__ 在发出去后，不会阻塞当前进/线程，而会立即返回。

* 生活中的例子
    1. 阻塞买奶茶：小明点单交钱，干等着拿奶茶，什么事都不做； 
    2. 非阻塞买奶茶：小明点单交钱，等着拿奶茶，等的过程中，时不时刷刷微博、朋友圈。


## 1.3 总结
* 通过上面的分析，我们可以得知：
    * __同步与异步__，重点在于消息通知的方式;
    
    * __阻塞与非阻塞__，重点在于等消息时候的行为。

* 所以，就有了下面4种组合方式：
    1. 同步阻塞：小明在柜台干等着拿奶茶；

    2. 同步非阻塞：小明在柜台边刷微博边等着拿奶茶；

    3. 异步阻塞：小明拿着小票啥都不干，一直等着店员通知他拿奶茶；

    4. 异步非阻塞：小明拿着小票，刷着微博，等着店员通知他拿奶茶。


## 2. IO 复用

### IO 复用例子说明
* 假设你是一个机场的空管，你需要管理到你机场的所有的航线， 包括进港，出港，有些航班需要放到停机坪等待，有些航班需要去登机口接乘客。

* 你会怎么做?
    * 最简单的做法，就是你去招一大批空管员，然后每人盯一架飞机， 从进港，接客，排位，出港，航线监控，直至交接给下一个空港，全程监控。

* 那么问题就来了：
    * 很快你就发现空管塔里面聚集起来一大票的空管员，交通稍微繁忙一点，新的空管员就已经挤不进来了。空管员之间需要协调，屋子里面就1,2个人的时候还好，几十号人以后 ，基本上就成菜市场了。

    * 空管员经常需要更新一些公用的东西，比如起飞显示屏，比如下一个小时后的出港排期，最后你会很惊奇的发现，每个人的时间最后都花在了抢这些资源上。

* 现实上我们的空管同时管几十架飞机稀松平常的事情:
    * ![flight progress strip](./images/flight_progress_strip.jpg)

    * 他们怎么做的呢？这个东西叫flight progress strip。

    * 每一个块代表一个航班，不同的槽代表不同的状态，然后一个空管员可以管理一组这样的块（一组航班），而他的工作，就是在航班信息有新的更新的时候，把对应的块放到不同的槽子里面。

    * 这个东西现在还没有淘汰哦，只是变成电子的了而已。

    * 是不是觉得一下子效率高了很多，一个空管塔里可以调度的航线可以是前一种方法的几倍到几十倍。

    * 如果你 __把每一个航线当成一个Sock(I/O流)__, 空管当成你的服务端Sock管理代码的话.

* 其实 __I/O多路复用__ 这个坑爹翻译可能是这个概念在中文里面如此难理解的原因。所谓的I/O多路复用在英文中其实叫 _I/O multiplexing_.

* 重要的事情再说一遍： I/O multiplexing 这里面的 `multiplexing` 指的其实是 __在单个线程通过记录跟踪每一个Sock(I/O流)的状态__ (对应空管塔里面的Fight progress strip槽) __来同时管理多个I/O流__. 发明它的原因，是尽量多的提高服务器的吞吐能力。

* 是不是听起来好拗口，看个图就懂了: 
    * ![](./images/multiplexing.gif)

    * __在同一个线程里面__，通过拨开关的方式，来同时传输多个I/O流
